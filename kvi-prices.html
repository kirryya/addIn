<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SmartPricing Task Pane</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="forms.css">
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>
<body>

<div id="settingsModal">
        <span class="title">Рекомендации, оптимизация KVI</span>
    <div id="tabs">
        <button class="tab-button active" data-tab="general" type="button">Уровни</button>
        <button class="tab-button" data-tab="advanced" type="button">Параметры</button>
    </div>
    <form id="settingsForm">
        <div class="tab-pane active" id="general">
            Учитывать категории
            <div class="checkbox-title">
                <label class="custom-checkbox">
                    <input type="checkbox" name="generalCheckbox2" data-target="#generalInput1">
                    <span></span>
                    Считать по кластерам по отдельности
                </label>
            </div>
        </div>

        <div class="tab-pane" id="advanced">


                <div id="subTabContent">
                    <!-- Подтаб 1 -->
                    <div class="sub-tab-pane active" id="license">
                        <div class="sub-tab-container_subtitle">
                            <label for="licenseInput4" class="subtitle">Количество KVI в рекомендациях, %</label>
                            <input type="text" id="licenseInput4" name="licenseInput4" class="key_input"
                                   autocomplete="off" min="0" max="100" placeholder="Ведите число от 0 до 100" required>
                        </div>
                        <div class="checkbox-title">
                                <label class="custom-checkbox">
                                    <input type="checkbox" name="licenseCheckbox2" data-target="#licenseInput1">
                                    <span></span>
                                    Компенсировать снижение целевых показателей
                                </label>
                            </div>
                        <div class="checkbox-title">
                                <label class="custom-checkbox">
                                    <input type="checkbox" id="useCodesCheckbox1" name="useCodes">
                                    <span></span>
                                    Проверять на предел снижения рентабельности
                                </label>
                            </div>
                        <div class="checkbox-title">
                            <label class="custom-checkbox">
                                <input type="checkbox" id="useCodesCheckbox" name="useCodes">
                                <span></span>
                                Проверять на предел снижения рентабельности
                            </label>
                        </div>
                    </div>
                </div>
            </div>

        <div style="margin-left: auto; padding: 0;">
            <button type="submit" style="max-width: 97px">Расчёт</button>

<!--            <button type="button" id="close-button" style="max-width: 97px">Отмена</button>-->
        </div>
    </form>

    <div id="statusArea" style="margin-top: 20px; text-align: center;"></div>
</div>

<script>
    // справочник категорий
    const categoriesMap = {
        food: [
            { value: "dairy", text: "Молочные продукты" },
            { value: "bakery", text: "Хлебобулочные изделия" },
            { value: "meat", text: "Мясо и птица" },
            { value: "fruits", text: "Овощи и фрукты" }
        ],
        drinks: [
            { value: "water", text: "Вода" },
            { value: "juices", text: "Соки и нектары" },
            { value: "tea", text: "Чай и кофе" },
            { value: "alcohol", text: "Алкогольные напитки" }
        ],
        chemistry: [
            { value: "laundry", text: "Средства для стирки" },
            { value: "cleaning", text: "Чистящие средства" },
            { value: "dishes", text: "Средства для мытья посуды" },
            { value: "airfresh", text: "Освежители воздуха" }
        ],
        electronics: [
            { value: "phones", text: "Смартфоны" },
            { value: "laptops", text: "Ноутбуки" },
            { value: "tv", text: "Телевизоры" },
            { value: "appliances", text: "Мелкая бытовая техника" }
        ]
    };

    document.addEventListener("DOMContentLoaded", () => {
        // Инициализация всех кастомных селектов
        function initCustomSelect(wrapper) {
            const select = wrapper.querySelector(".custom-select");
            const trigger = select.querySelector(".custom-select-trigger");
            const optionsContainer = select.querySelector(".custom-options");
            const hiddenInput = wrapper.querySelector("input[type=hidden]");

            function attachOptionHandlers() {
                const options = optionsContainer.querySelectorAll(".custom-option");
                options.forEach(option => {
                    option.addEventListener("click", () => {
                        trigger.textContent = option.textContent;
                        hiddenInput.value = option.dataset.value;

                        options.forEach(o => o.classList.remove("selected"));
                        option.classList.add("selected");

                        select.classList.remove("open");

                        hiddenInput.dispatchEvent(new Event("change", { bubbles: true }));
                    });
                });
            }

            attachOptionHandlers();

            trigger.addEventListener("click", () => {
                document.querySelectorAll(".custom-select.open").forEach(openSelect => {
                    if (openSelect !== select) openSelect.classList.remove("open");
                });
                select.classList.toggle("open");
            });

            return { optionsContainer, trigger, hiddenInput, attachOptionHandlers };
        }

        // все кастомные селекты на странице
        const wrappers = document.querySelectorAll(".custom-select-wrapper");
        const selects = Array.from(wrappers).map(wrapper => initCustomSelect(wrapper));

        document.addEventListener("click", e => {
            if (!e.target.closest(".custom-select-wrapper")) {
                document.querySelectorAll(".custom-select.open").forEach(s => s.classList.remove("open"));
            }
        });

        // каскадная логика: generalSelect1 → generalSelect2
        const groupSelect = selects.find(s => s.hiddenInput.id === "generalSelect1");
        const categorySelect = selects.find(s => s.hiddenInput.id === "generalSelect2");

        groupSelect.hiddenInput.addEventListener("change", () => {
            const selectedGroup = groupSelect.hiddenInput.value;

            // очищаем категории
            categorySelect.optionsContainer.innerHTML = '';
            categorySelect.trigger.textContent = 'Все';
            categorySelect.hiddenInput.value = 'all';

            // добавляем "Все"
            const allOption = document.createElement('span');
            allOption.classList.add('custom-option', 'selected');
            allOption.dataset.value = 'all';
            allOption.textContent = 'Все';
            categorySelect.optionsContainer.appendChild(allOption);

            // добавляем новые опции
            if (selectedGroup !== 'all' && categoriesMap[selectedGroup]) {
                categoriesMap[selectedGroup].forEach(cat => {
                    const option = document.createElement('span');
                    option.classList.add('custom-option');
                    option.dataset.value = cat.value;
                    option.textContent = cat.text;
                    categorySelect.optionsContainer.appendChild(option);
                });
            }

            categorySelect.attachOptionHandlers();
        });
    });

    document.querySelectorAll(".tab-button").forEach(btn => {
        btn.addEventListener("click", () => {
            // убираем active со всех кнопок
            document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
            // активируем выбранную
            btn.classList.add("active");

            // скрываем все вкладки
            document.querySelectorAll(".tab-pane").forEach(pane => pane.classList.remove("active"));
            // показываем нужную
            document.getElementById(btn.dataset.tab).classList.add("active");
        });
    });

    document.querySelectorAll(".sub-tab-button").forEach(btn => {
        btn.addEventListener("click", () => {
            // убрать active у кнопок
            document.querySelectorAll(".sub-tab-button").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            // спрятать все панели
            document.querySelectorAll(".sub-tab-pane").forEach(p => p.classList.remove("active"));
            document.getElementById(btn.dataset.subtab).classList.add("active");
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        const autoDeviationCheckbox = document.querySelector('input[name="groupsCheckbox4"]');
        const deviationInput = document.getElementById("groupsInput9");

        function toggleDeviation() {
            if (autoDeviationCheckbox.checked) {
                deviationInput.disabled = true;  // задизэйблить
                deviationInput.classList.add("disabled");
            } else {
                deviationInput.disabled = false; // разблокировать
                deviationInput.classList.remove("disabled");
            }
        }

        // при загрузке страницы
        toggleDeviation();

        // при изменении чекбокса
        autoDeviationCheckbox.addEventListener("change", toggleDeviation);
    });

    document.addEventListener("DOMContentLoaded", function () {
        const autoBrandCheckbox = document.querySelector('input[name="categoriesCheckbox1"]');
        const priceFamiliesCheckbox = document.querySelector('input[name="categoriesCheckbox3"]');

        function togglePriceFamilies() {
            if (autoBrandCheckbox.checked) {
                priceFamiliesCheckbox.disabled = true;  // задизэйблить
                priceFamiliesCheckbox.parentElement.classList.add("disabled");
            } else {
                priceFamiliesCheckbox.disabled = false; // разблокировать
                priceFamiliesCheckbox.parentElement.classList.remove("disabled");
            }
        }

        // при загрузке страницы
        togglePriceFamilies();

        // при изменении чекбокса
        autoBrandCheckbox.addEventListener("change", togglePriceFamilies);
    });

    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll('input[type="checkbox"][data-target]').forEach(chk => {
            const targetSelector = chk.dataset.target;
            const targetEl = document.querySelector(targetSelector)?.closest('.sub-tab-container');

            if (!targetEl) return;

            function toggleBlock() {
                const show = chk.checked;
                targetEl.classList.toggle("hidden", !show);
                targetEl.querySelectorAll("input, select, textarea, button").forEach(el => {
                    el.disabled = !show;
                });
            }

            // при загрузке страницы
            toggleBlock();
            // при клике
            chk.addEventListener("change", toggleBlock);
        });
    });

    // Office.onReady(() => {
    //     const form = document.getElementById("settingsForm");
    //     const closeBtn = document.getElementById("close-button");
    //
    //     form.onsubmit = async (e) => {
    //         e.preventDefault();
    //
    //         // 1. Собираем данные формы
    //         const formData = new FormData(form);
    //         let payload = {};
    //         for (let [k, v] of formData.entries()) payload[k] = v;
    //
    //         // 2. Сначала получаем список доступных листов
    //         // let sheetsInfo = [];
    //         // await Excel.run(async context => {
    //         //     const sheets = context.workbook.worksheets;
    //         //     sheets.load("items/name");
    //         //     await context.sync();
    //         //     sheetsInfo = sheets.items.map(s => s.name);
    //         // });
    //
    //         // 3. Обрабатываем нужные листы
    //         // const sheetNames = ["Ассортимент", "Продажи", "Цены конкурентов"];
    //         // let filesToSend = [];
    //
    //         // for (const sheetName of sheetNames) {
    //         //     if (!sheetsInfo.includes(sheetName)) {
    //         //         console.warn(`Лист ${sheetName} не найден`);
    //         //         continue;
    //         //     }
    //         //
    //         //     await Excel.run(async context => {
    //         //         try {
    //         //             const sheet = context.workbook.worksheets.getItem(sheetName);
    //         //             const range = sheet.getUsedRange();
    //         //             range.load("values");
    //         //             await context.sync();
    //         //
    //         //             const values = range.values;
    //         //             payload[sheetName] = values;
    //         //             filesToSend.push({ sheetName, values });
    //         //         } catch (err) {
    //         //             console.error(`Ошибка при обработке листа ${sheetName}:`, err);
    //         //         }
    //         //     });
    //         // }
    //
    //         // 4. Конвертируем данные в XLSX файлы через SheetJS
    //         // for (const file of filesToSend) {
    //         //     const ws = XLSX.utils.aoa_to_sheet(file.values);
    //         //     const newWb = XLSX.utils.book_new();
    //         //     XLSX.utils.book_append_sheet(newWb, ws, file.sheetName);
    //         //     file.base64 = XLSX.write(newWb, { bookType: "xlsx", type: "base64" });
    //         // }
    //
    //         // 5. Отправляем payload + файлы на сервер
    //         // try {
    //         //     const formDataToSend = new FormData();
    //         //
    //         //     for (const key in payload) formDataToSend.append(key, JSON.stringify(payload[key]));
    //         //
    //         //     filesToSend.forEach(file => {
    //         //         const byteString = atob(file.base64);
    //         //         const ab = new ArrayBuffer(byteString.length);
    //         //         const ia = new Uint8Array(ab);
    //         //         for (let i = 0; i < byteString.length; i++) ia[i] = byteString.charCodeAt(i);
    //         //         const blob = new Blob([ab], { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });
    //         //         formDataToSend.append("files[]", blob, `${file.sheetName}.xlsx`);
    //         //     });
    //         //
    //         //     const response = await fetch("https://your-server.com/api/process", {
    //         //         method: "POST",
    //         //         body: formDataToSend
    //         //     });
    //         //
    //         //     const result = await response.json();
    //         //     console.log("Ответ сервера:", result);
    //         // } catch (err) {
    //         //     console.error("Ошибка при отправке:", err);
    //         // }
    //
    //         if (Office.context.ui?.messageParent) Office.context.ui.messageParent("close");
    //     };
    //
    //     closeBtn.onclick = () => {
    //         if (Office.context.ui?.messageParent) Office.context.ui.messageParent("close");
    //     };
    // });

    Office.onReady(() => {
        const form = document.getElementById("settingsForm");
        // const closeBtn = document.getElementById("close-button");
        const statusArea = document.getElementById("statusArea");

        async function fetchTime() {
            try {
                const res = await fetch("https://worldtimeapi.org/api/timezone/Europe/Moscow");
                const data = await res.json();
                console.log("Текущее время:", data.datetime);
            } catch (err) {
                console.error("Ошибка запроса времени:", err);
            }
        }

        async function runRequests() {
            statusArea.innerHTML = `
      <div class="loader"></div>
      <p id="progressText">0 / 20</p>
    `;

            for (let i = 0; i < 20; i++) {
                await fetchTime();
                document.getElementById("progressText").innerText = `${i + 1} / 20`;
                await new Promise(r => setTimeout(r, 1000)); // пауза 1 сек
            }

            statusArea.innerHTML = `
      <div class="checkmark"></div>
      <p>Готово!</p>
    `;
        }

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            runRequests();
        });

        // closeBtn.addEventListener("click", () => {
        //     if (Office.context.ui?.messageParent) {
        //         Office.context.ui.messageParent(JSON.stringify({ action: "close" }));
        //     }
        // });
    });

    document.addEventListener("DOMContentLoaded", () => {

        const checkbox1 = document.getElementById("useCodesCheckbox");
        const inputsContainer1 = document.getElementById("codesInputs1");

     // по умолчанию скрываем
        inputsContainer1.style.display = "none";

        checkbox1.addEventListener("change", () => {
        if (checkbox1.checked) {
             inputsContainer1.style.display = "flex";
         } else {
            inputsContainer1.style.display = "none";
            }
        });
    });
</script>
</body>
</html>